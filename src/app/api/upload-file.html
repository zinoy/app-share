<div class="wrapper wrapper-content animated fadeInRight" ng-controller="ApiController as share">
  <div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-sm-4">
      <h2>{{$state.current.data.pageTitle}}</h2>
      <ol class="breadcrumb">
        <li>
          <a ui-sref="api.index">Home</a>
        </li>
        <li class="active">
          <strong>{{$state.current.data.title}}</strong>
        </li>
      </ol>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-12">
      <div class="wrapper wrapper-content">
        <div class="ibox api-spec">
          <div class="ibox-title">
            <h5>接口文档</h5>
            <div ibox-tools control="iboxTools"></div>
          </div>
          <div class="ibox-content">
            <div class="panel panel-primary">
              <div class="panel-heading">列表</div>
              <div class="panel-body">
                <ul>
                  <li><a href="#upload-image">图片上传</a></li>
                  <li><a href="#upload-file">大文件上传</a></li>
                </ul>
              </div>
            </div>
            <section id="upload-image">
              <h2>图片上传</h2>
              <h3>URL</h3>
              <h4>别克</h4>
              <p><code>http://webtest.buick.com.cn/apinew/upimgapi.aspx</code>（PC测试）</p>
              <p><code>https://www.buick.com.cn/apinew/upimgapi.aspx</code>（PC正式）</p>
              <p><code>http://mobiletest.buick.com.cn/apinew/upimgapi.aspx</code>（移动端测试）</p>
              <p><code>https://m.buick.com.cn/apinew/upimgapi.aspx</code>（移动端正式）</p>
              <h4>雪佛兰</h4>
              <p><code>http://webtest.chevrolet.com.cn/apinew/upimgapi.aspx</code>（PC测试）</p>
              <p><code>https://www.chevrolet.com.cn/apinew/upimgapi.aspx</code>（PC正式）</p>
              <p><code>http://mobiletest.chevrolet.com.cn/apinew/upimgapi.aspx</code>（移动端测试）</p>
              <p><code>https://m.chevrolet.com.cn/apinew/upimgapi.aspx</code>（移动端正式）</p>
              <h3>方式</h3>
              <p>POST</p>
              <h3>参数</h3>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>参数名</th>
                    <th>类型</th>
                    <th>默认值</th>
                    <th>是否必须</th>
                    <th>说明</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th>picpath</th>
                    <td>String</td>
                    <td> </td>
                    <td>可选</i></td>
                    <td>
                      <p>图片保存路径。遵循以下规则：</p>
                      <ul>
                        <li><b>为空</b>：图片将保存至默认目录 <code>/uploadfiles/pubapi/</code></li>
                        <li><b>相对地址</b> (如 <code>actname/</code>) <i class="fa fa-star" title="推荐"></i>：上传至默认目录下的指定路径 <code>/uploadfiles/pubapi/actname/</code></li>
                        <li><b>绝对地址</b> (如 <code>/act/brand/img/</code>)：上传至网站根目录下的指定路径，需要接口有对应的权限</li>
                      </ul>
                    </td>
                  </tr>
                  <tr>
                    <th>filedata</td>
                    <td>String</td>
                    <td> </td>
                    <td>可选</td>
                    <td>Base64编码的二进制字符串，如为空则使用二进制文件。建议使用二进制传输。</td>
                  </tr>
                </tbody>
              </table>
              <p class="alert">带 <i class="fa fa-star"></i> 的为推荐使用的值或类型。</p>
              <h3>返回格式</h3>
              <p>JSON</p>
              <h3>返回示例</h3>
              <ui-codemirror ui-codemirror-opts="share.jsOptions">{
  "status": "1",
  "message": "上传成功",
  "picpath": "/uploadfiles/pubapi/2017-09-01/",
  "pics": ["6b46772a-14e6-45d2-8745-8768b011891b.png"]
}</ui-codemirror>
            </section>
            <section id="upload-file">
              <h2>大文件上传</h2>
              <p>上传接口使用<a href="https://tus.io/" target="_blank">tus <i class="fa fa-external-link"></i></a>协议，支持断点续传，适合用于上传大文件。</p>
              <h3>URL</h3>
              <p><i>待补充</i></p>
              <h3>meta参数</h3>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>参数名</th>
                    <th>类型</th>
                    <th>默认值</th>
                    <th>是否必须</th>
                    <th>说明</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th>name</th>
                    <td>String</td>
                    <td> </td>
                    <td>必填</i></td>
                    <td>文件名</td>
                  </tr>
                  <tr>
                    <th>contentType</td>
                    <td>String</td>
                    <td> </td>
                    <td>必填</td>
                    <td>文件类型</td>
                  </tr>
                  <tr>
                    <th>path</th>
                    <td>String</td>
                    <td> </td>
                    <td>可选</td>
                    <td>
                      <p>图片保存路径。遵循以下规则：</p>
                      <ul>
                        <li><b>为空</b>：图片将保存至默认目录 <code>/uploadfiles/pubapi/</code></li>
                        <li><b>相对地址</b> (如 <code>actname/</code>) <i class="fa fa-star" title="推荐"></i>：上传至默认目录下的指定路径 <code>/uploadfiles/pubapi/actname/</code></li>
                        <li><b>绝对地址</b> (如 <code>/act/brand/img/</code>)：上传至网站根目录下的指定路径，需要接口有对应的权限</li>
                      </ul>
                    </td>
                  </tr>
                </tbody>
              </table>
            </section>
          </div>
        </div>
        <div class="ibox">
          <div class="ibox-title">
            <h5>兼容性</h5>
            <div ibox-tools control="iboxTools"></div>
          </div>
          <div class="ibox-content">
            <p>Android浏览器版本<b>50</b>以及iOS<b>11</b>之前的canvas不支持 <code>toBlob()</code> 方法，为了能兼容各主流手机平台，可在JS中插入以下代码：</p>
            <ui-codemirror ui-codemirror-opts="share.jsOptions">if (!HTMLCanvasElement.prototype.toBlob) {
  Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
    value: function (callback, type, quality) {

      var binStr = atob( this.toDataURL(type, quality).split(',')[1] ),
          len = binStr.length,
          arr = new Uint8Array(len);

      for (var i = 0; i &lt; len; i++ ) {
        arr[i] = binStr.charCodeAt(i);
      }

      callback( new Blob( [arr], {type: type || 'image/png'} ) );
    }
  });
}</ui-codemirror>
          </div>
        </div>
        <div class="ibox">
          <div class="ibox-title">
            <h5>代码示例</h5>
            <div ibox-tools control="iboxTools"></div>
          </div>
          <div class="ibox-content">
            <p>示例中用到的JS库：</p>
            <ul class="m-b-md">
              <li><a href="https://github.com/stomita/ios-imagefile-megapixel" target="_blank">stomita/ios-imagefile-megapixel <i class="fa fa-external-link"></i></a>
              <span>此插件可优化上传图片大小，提高手机性能。</span></li>
              <li><a href="https://github.com/fengyuanchen/cropper" target="_blank">fengyuanchen/cropper <i class="fa fa-external-link"></i></a>
                <span>此插件可对图片放大缩小旋转裁切。</span></li>
            </ul>
            <h3>图片加载</h3>
            <ui-codemirror ui-codemirror-opts="share.jsOptions">/*
 * 检查图片朝向
 */
function getOrientation(t){var e=new DataView(t);if(65496!=e.getUint16(0,!1))return-2;for(var n=e.byteLength,i=2;i&lt;n;){var r=e.getUint16(i,!1);if(i+=2,65505==r){if(1165519206!=e.getUint32(i+=2,!1))return-1;var g=18761==e.getUint16(i+=6,!1);i+=e.getUint32(i+4,g);var a=e.getUint16(i,g);i+=2;for(var U=0;U&lt;a;U++)if(274==e.getUint16(i+12*U,g))return e.getUint16(i+12*U+8,g)}else{if(65280!=(65280&amp;r))break;i+=e.getUint16(i,!1)}}return-1}

$('#file_input').on('change', function() {
  var file = this.files[0];
  if (this.files.length > 0) {
    var type = file.type, reader = new FileReader();
    reader.onloadend = function() {

      var uploadImg = new Image();
      var autoRotated = false;
      var styles = getComputedStyle(uploadImg);
      if (styles.getPropertyValue('image-orientation') === 'from-image') {
        autoRotated = true;
      }
      // Chrome 81版本之后默认情况下图片会根据EXIF自动旋转
      // 增加一个判断，以避免图片被再次转换
      var orientation = autoRotated ? 1 : getOrientation(reader.result);

      var blob = new Blob([reader.result], {type: "image/jpeg"});
      var urlCreator = window.URL || window.webkitURL;
      var imageUrl = urlCreator.createObjectURL(blob);

      var uploadSize = { // 指定上传的图片尺寸，建议固定上传尺寸
        height: 1024,
        width: 1024
      };
      uploadImg.onload = function() {
        var imageWidth = uploadImg.width, imageHeight = uploadImg.height;
        var sw = Math.min(imageWidth, imageHeight);
        var rw = uploadSize.width / imageWidth, rh = uploadSize.height / imageHeight;
        var ratio = Math.max(rw, rh);
        var dw = Math.ceil(imageWidth * ratio), dh = Math.ceil(imageHeight * ratio);

        // 创建一个临时的canvas
        var tmpCanvas = document.createElement('canvas');
        if (orientation >= 5) {
          rw = uploadSize.width / imageHeight;
          rh = uploadSize.height / imageWidth;
          ratio = Math.max(rw, rh);
          dw = Math.round(imageWidth * ratio);
          dh = Math.round(imageHeight * ratio);
        }
        var mpImg = new MegaPixImage(uploadImg);
        mpImg.render(tmpCanvas, {
          width : dw,
          height : dh,
          quality : 0.8, // 图片质量
          orientation : orientation
        });

        // 初始化图片裁剪
        $('.cropper canvas').replaceWith(tmpCanvas);
        $('.cropper').show();
        $(tmpCanvas).cropper({
          viewMode: 1,
          dragMode: 'move',
          aspectRatio: 1,
          guides: false,
          center: false,
          cropBoxMovable: false,
          cropBoxResizable: false,
          toggleDragModeOnDblclick: false
        });
      };
      uploadImg.src = imageUrl;
    };
    reader.readAsArrayBuffer(this.files[0]);
  }
});</ui-codemirror>
            <div class="m-b-md"></div>
            <h3>图片上传</h3>
            <ui-codemirror ui-codemirror-opts="share.jsOptions">var formData = new FormData();
canvas.toBlob(function(blob) {
  formData.append('pic[]', blob); // 上传至默认目录
  //formData.append('picpath', 'xxxx-folder/'); // optional, 上传到指定目录下
  $.ajax(apiPath + 'apinew/upimgapi.aspx', {
    method: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    dataType: 'json'
  }).done(function(data) {
    $('pre code').html(JSON.stringify(data));
    if(data.status==1){
      $('#result').show();
      $('#form').hide();
      $('#preview').empty();
      data.pics.forEach(function(item,index){
        $('#preview').append(`&lt;img src="${apiPath + data.picpath + item}">`); // 此$符号为ES6字串操作
      });
    }else{
      alert('上传失败：' + data.status);
    }
  }).fail(function(a,b) {
    console.error(a,b);
    alert('服务器错误');
  }).always(function() {
    waiting = false;
  });  
});</ui-codemirror>
            <div class="m-b-md"></div>
            <h3>大文件上传</h3>
            <p>由于tus协议的复杂性，推荐使用其官方的 <a href="https://github.com/tus/tus-js-client" target="_blank">Javascript库 <i class="fa fa-external-link"></i></a>。上传二进制数据（如Canvas对象导出的Blob）可将 <code>tus.Upload(file, options)</code> 第一个参数 <b>file</b> 替换为对应的二进制对象（可为 <code>Blob</code> 或 <code><a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStreamDefaultReader" target="_blank">Reader</a></code>）。</p>
            <ui-codemirror ui-codemirror-opts="share.jsOptions">input.addEventListener("change", function(e) {
  // 从input元素获取文件
  var file = e.target.files[0]

  // 创建 tus 上传实例
  var upload = new tus.Upload(file, { // file 还可以为 Blob 或 Reader 类型
    endpoint: "http://localhost:1080/files/", // 上传接口URL
    retryDelays: [0, 3000, 5000, 10000, 20000],
    metadata: {
      name: file.name,
      contentType: file.type || 'application/octet-stream',
      path: '' // 保存文件的路径（子目录）
    },
    onError: function(error) {
      console.log("Failed because: " + error)
    },
    onProgress: function(bytesUploaded, bytesTotal) {
      var percentage = (bytesUploaded / bytesTotal * 100).toFixed(2)
      console.log(bytesUploaded, bytesTotal, percentage + "%")
    },
    onSuccess: function() {
      // 上传成功，返回URL
      console.log("Download %s from %s", upload.file.name, upload.url)
    }
  })

  // 开始上传
  upload.start()
})</ui-codemirror>
          </div>
        </div>
        <div class="ibox">
          <div class="ibox-title">
            <h5>演示（仅图片上传接口）</h5>
          </div>
          <div class="ibox-content">
            <div class="row">
              <div class="col-md-6"><iframe frameborder="0" width="360" height="540" src="/demo/img-upload.html"></iframe></div>
              <div class="col-md-6">
                <p><img src="" alt="qrcode" id="qrcode"></p>
                <script>
                  var url = location.protocol + '//' + location.host + '/demo/img-upload.html';
                  $('#qrcode').attr('src', 'https://util.zino.co/php/qrcode.php?chl=' + encodeURIComponent(url) + '&chs=5&chld=M&cht=qr').parent().after('<p><a href="' + url + '" target="_blank">' + url + ' <i class="fa fa-external-link"></i></a></p>');
                </script>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
